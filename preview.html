<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NTX Arena - Red Zone</title>
    <script src="tailwind.js"></script>
    <script src="ethers.js" type="application/javascript"></script>
    <!-- Web3Modal & WalletConnect -->
    <script src="https://unpkg.com/web3modal@1.9.12/dist/index.js"></script>
    <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-red: #FF3D00;
            --neon-dark-red: #b71c1c;
            --neon-gold: #FFD700;
            --bg-dark: #050505;
        }

        /* --- Web3Modal Custom Theme (Red Alert Style) --- */
        #WEB3_CONNECT_MODAL_ID {
            z-index: 10000 !important;
            position: fixed !important;
        }
        .web3modal-modal-lightbox {
            background: rgba(0, 0, 0, 0.8) !important;
            backdrop-filter: blur(5px) !important;
        }
        .web3modal-modal-card {
            background: #1a0505 !important;
            border: 2px solid var(--neon-red) !important;
            box-shadow: 0 0 30px rgba(255, 61, 0, 0.3) !important;
            border-radius: 12px !important;
        }
        .web3modal-provider-container {
            background-color: #2b1010 !important;
            border: 1px solid #551010 !important;
            border-radius: 8px !important;
            padding: 20px !important;
            transition: all 0.2s !important;
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            justify-content: center !important;
        }
        .web3modal-provider-container:hover {
            background-color: #3b1515 !important;
            border-color: var(--neon-red) !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(255, 61, 0, 0.2) !important;
        }
        .web3modal-provider-name {
            color: white !important;
            font-family: 'Roboto Mono', monospace !important;
            font-weight: bold !important;
            margin-top: 10px !important;
            font-size: 16px !important;
        }
        .web3modal-provider-description {
            color: #aaa !important;
            font-family: 'Roboto Mono', monospace !important;
            font-size: 12px !important;
            margin-top: 5px !important;
            text-align: center !important;
        }
        .web3modal-provider-icon {
            width: 45px !important;
            height: 45px !important;
        }
        
        body {
            background-color: var(--bg-dark);
            font-family: 'Roboto Mono', monospace;
            color: white;
            overflow: hidden;
            touch-action: none;
        }

        /* ËµåÂçöÈ£éÊ†ºÁ∫¢Ëâ≤ËÉåÊôØ */
        .casino-bg {
            position: absolute;
            inset: 0;
            background: 
                /* ‰∏≠ÂøÉÊ∑±Á∫¢ÂÖâÊôï */
                radial-gradient(circle at 50% 50%, rgba(100, 10, 10, 0.8) 0%, rgba(10, 5, 5, 1) 90%),
                /* Âä®ÊÄÅÁΩëÊ†º */
                linear-gradient(rgba(255, 61, 0, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 61, 0, 0.1) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            perspective: 1000px;
            z-index: 0;
            animation: bg-pulse 4s infinite alternate;
        }

        @keyframes bg-pulse {
            0% { filter: brightness(1); }
            100% { filter: brightness(1.2); }
        }

        /* Ê∏∏Êàè‰∏ªËàûÂè∞ */
        #game-stage {
            position: relative;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        /* È°∂ÈÉ® HUD */
        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: linear-gradient(to bottom, rgba(50, 0, 0, 0.9), transparent);
            border-bottom: 1px solid rgba(255, 61, 0, 0.2);
            z-index: 50;
        }

        /* ÊàøÈó¥ÂÆπÂô® */
        #map-container {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 800px;
        }

        #arena-grid {
            position: relative;
            width: 340px;
            height: 340px;
            transform-style: preserve-3d;
            transform: rotateX(20deg) scale(1.1);
        }

        /* ÊàøÈó¥Âç°Áâá - 3D Êú®Ë¥®È£éÊ†º */
        .room-card {
            position: absolute;
            width: 105px;
            height: 105px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end; /* ÂÜÖÂÆπÈù†‰∏ã */
            padding-bottom: 10px;
            transition: all 0.2s;
            cursor: pointer;
            z-index: 10;
            /* ÁßªÈô§ÊóßÁöÑËÉåÊôØÔºå‰ΩøÁî® SVG */
        }

        .room-bg-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5));
        }

        .room-card:hover {
            transform: translateY(-5px);
        }
        
        .room-card:hover .room-bg-svg path {
            stroke: var(--neon-red);
            stroke-width: 2px;
        }

        .room-card.selected .room-bg-svg path {
            stroke: var(--neon-gold);
            stroke-width: 3px;
            filter: drop-shadow(0 0 10px var(--neon-gold));
        }

        .room-card.impacted {
            animation: shake-red 0.3s;
        }
        
        .room-card.impacted .room-bg-svg {
            filter: sepia(1) saturate(5) hue-rotate(-50deg); /* ÂèòÁ∫¢ */
        }

        /* Èü≠Ëèú (Êõø‰ª£Â∞è‰∫∫) */
        .people-group {
            position: absolute;
            bottom: 25px; /* ÊîæÂú®Âõ¥Ê†èÂêéÈù¢ */
            left: 10px;
            width: 85px;
            height: 40px;
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            justify-content: center;
            align-items: flex-end;
            z-index: 0; /* Âú®Âõ¥Ê†èÂêéÈù¢ */
        }
        
        .leek {
            width: 4px;
            height: 12px;
            background: linear-gradient(to top, #fff 10%, #4CAF50 40%, #2E7D32 100%);
            border-radius: 2px;
            position: relative;
            animation: sway 2s infinite ease-in-out;
            transform-origin: bottom center;
        }
        
        /* Èü≠ËèúÂè∂Â≠ê */
        .leek::before {
            content: '';
            position: absolute;
            top: 0;
            left: -2px;
            width: 4px;
            height: 6px;
            background: #4CAF50;
            border-radius: 0 100% 0 0;
            transform: rotate(-15deg);
        }
        .leek::after {
            content: '';
            position: absolute;
            top: 1px;
            right: -2px;
            width: 3px;
            height: 5px;
            background: #66BB6A;
            border-radius: 100% 0 0 0;
            transform: rotate(15deg);
        }

        @keyframes sway { 
            0%, 100% { transform: rotate(-5deg); } 
            50% { transform: rotate(5deg); } 
        }

        /* ÊàøÈó¥ÂêçÁß∞Ê†áÁ≠æ */
        .room-label {
            position: absolute;
            top: -15px;
            background: #000;
            color: var(--neon-gold);
            font-size: 10px;
            padding: 2px 6px;
            border: 1px solid var(--neon-red);
            border-radius: 4px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 20;
            box-shadow: 0 0 5px var(--neon-red);
        }

        /* ================= CSS Âç°ÈÄöÁâõ (‰øùÁïô‰Ω†ÂñúÊ¨¢ÁöÑÈÇ£‰∏™) ================= */
        #bull-character {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 80px;
            height: 80px;
            transform: translate(-50%, -50%);
            z-index: 100;
            transition: top 0.2s linear, left 0.2s linear; /* Âø´ÈÄüÁßªÂä® */
            pointer-events: none;
        }

        .bull-inner {
            width: 100%;
            height: 100%;
            position: relative;
            transition: transform 0.1s;
        }

        .bull-body {
            position: absolute;
            top: 20px;
            left: 10px;
            width: 60px;
            height: 45px;
            background: #D50000; /* È≤úÁ∫¢ */
            border-radius: 20px;
            box-shadow: inset -5px -5px 0 rgba(0,0,0,0.3);
            animation: body-run 0.2s infinite alternate;
        }

        .bull-head {
            position: absolute;
            top: 10px;
            left: -5px;
            width: 45px;
            height: 40px;
            background: #B71C1C;
            border-radius: 14px;
            z-index: 2;
            animation: head-bob 0.2s infinite alternate;
        }

        .bull-horns {
            position: absolute;
            top: -12px;
            left: -8px;
            width: 60px;
            height: 20px;
        }
        .bull-horns::before, .bull-horns::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 30px;
            background: #FFD700; /* ÈáëËßí */
            border-radius: 50%;
            top: 5px;
            border: 2px solid #B71C1C;
        }
        .bull-horns::before { left: 0; transform: rotate(-30deg); }
        .bull-horns::after { right: 0; transform: rotate(30deg); }

        .bull-eyes {
            position: absolute;
            top: 12px;
            left: 5px;
            width: 35px;
            display: flex;
            justify-content: space-between;
        }
        .eye {
            width: 12px;
            height: 12px;
            background: #FFEBEE;
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 5px red;
        }
        .eye::after {
            content: '';
            position: absolute;
            top: 3px;
            right: 2px;
            width: 6px;
            height: 6px;
            background: red; /* Á∫¢Áúº */
            border-radius: 50%;
        }

        .bull-nose {
            position: absolute;
            bottom: 6px;
            left: 12px;
            width: 22px;
            height: 14px;
            background: #FFCDD2;
            border-radius: 10px;
        }
        .bull-nose-ring {
            position: absolute;
            bottom: -6px;
            left: 18px;
            width: 12px;
            height: 12px;
            border: 3px solid #FFD700;
            border-radius: 50%;
        }

        @keyframes body-run { from { transform: translateY(0); } to { transform: translateY(-2px); } }
        @keyframes head-bob { from { transform: rotate(-2deg); } to { transform: rotate(2deg); } }

        /* Â∞òÂúüÁâπÊïà */
        .dust {
            position: absolute;
            width: 15px;
            height: 15px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: dust-anim 0.5s forwards;
            pointer-events: none;
        }
        @keyframes dust-anim {
            0% { transform: scale(0.5); opacity: 0.8; }
            100% { transform: scale(2); opacity: 0; }
        }

        /* Â∫ïÈÉ®ÊéßÂà∂Èù¢Êùø */
        .control-panel {
            background: #150505;
            border-top: 2px solid #551010;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 -10px 40px rgba(255, 0, 0, 0.1);
            z-index: 50;
        }

        .bet-options {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .chip-btn {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            border: 2px dashed #551010;
            background: #2b1010;
            color: #aaa;
            font-weight: bold;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }
        
        .chip-btn:hover { border-color: var(--neon-red); color: white; }
        
        .chip-btn.active {
            background: var(--neon-gold);
            color: black;
            border: 2px solid white;
            transform: scale(1.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        }

        .action-btn {
            background: linear-gradient(90deg, #FF3D00, #D50000);
            color: white;
            font-family: 'Bangers', cursive;
            font-size: 32px;
            letter-spacing: 2px;
            padding: 12px;
            border-radius: 8px;
            border: none;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.3);
            box-shadow: 0 6px 0 #8E0000, 0 0 20px rgba(255, 61, 0, 0.4);
            transition: all 0.1s;
        }

        .action-btn:active {
            transform: translateY(6px);
            box-shadow: 0 0 0 #8E0000;
        }

        .action-btn:disabled {
            background: #333;
            color: #555;
            box-shadow: none;
        }

        /* ÂÄíËÆ°Êó∂Â§ßÂ≠ó */
        .big-timer {
            position: absolute;
            top: 15%;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Bangers', cursive;
            font-size: 100px;
            color: rgba(255, 61, 0, 0.1);
            pointer-events: none;
            z-index: 0;
            text-shadow: 0 0 20px rgba(255, 0, 0, 0.2);
        }

        /* Ë¥≠‰π∞ÂºπÁ™ó */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal.active { display: flex; }
        .modal-content {
            background: #1a0505;
            border: 2px solid var(--neon-red);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 30px rgba(255, 61, 0, 0.3);
            text-align: center;
        }
        .copy-box {
            background: #000;
            border: 1px dashed #555;
            padding: 10px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
            color: var(--neon-gold);
            cursor: pointer;
        }
        .copy-box:active { background: #222; }

    </style>
</head>
<body>

    <div class="casino-bg"></div>

    <div id="game-stage">
        
        <!-- È°∂ÈÉ®‰ø°ÊÅØ -->
        <div class="hud-top">
            <div class="flex flex-col">
                <span class="text-red-400 text-[10px] font-bold tracking-widest">SURVIVORS SHARE</span>
                <span class="text-3xl font-bold text-yellow-400 font-mono drop-shadow-md">524,800</span>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="openBuyModal()" class="bg-yellow-600 hover:bg-yellow-500 text-black font-bold px-2 py-1 rounded text-xs border border-yellow-400 shadow-[0_0_10px_rgba(255,215,0,0.3)]">
                    BUY NTX
                </button>
                <button onclick="openRulesModal()" class="text-gray-400 hover:text-white text-xs font-bold border border-gray-600 px-2 py-1 rounded">
                    RULES
                </button>
                <a href="preview_cn.html" class="text-gray-400 hover:text-white text-xs font-bold border border-gray-600 px-2 py-1 rounded">
                    CN
                </a>
                <div class="text-right hidden sm:block">
                    <div class="text-[10px] text-red-400">MY CHIPS</div>
                    <div class="font-bold text-sm" id="user-balance">---</div>
                </div>
                <button id="connect-btn" onclick="connectWallet()" class="bg-red-900/50 border border-red-500 hover:bg-red-800 text-white px-3 py-2 rounded font-bold text-xs flex items-center gap-2">
                    <div id="wallet-indicator" class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                    <span id="wallet-btn-addr">CONNECT</span>
                </button>
            </div>
        </div>

        <!-- Ë∑ëÈ©¨ÁÅØ -->
        <div class="bg-black/60 text-red-300 text-xs py-1 overflow-hidden whitespace-nowrap border-y border-red-900/50 z-40">
            <div class="inline-block animate-[ticker_15s_linear_infinite]">
                üî• HIGH STAKES: 0x99...1a bet 10,000 on #4 ‚Ä¢ üêÇ BULL IS RAGING ‚Ä¢ üíÄ Only 1 Room Will Be Destroyed ‚Ä¢ üí∞ Survivors Share The Loser's Pot ‚Ä¢
            </div>
        </div>

        <!-- ËÉåÊôØÂ§ßÂÄíËÆ°Êó∂ -->
        <div id="bg-timer" class="big-timer">60</div>

        <!-- ‰∏≠Èó¥Á´ûÊäÄÂú∫ -->
        <div id="map-container">
            <div id="arena-grid">
                <!-- ÊàøÈó¥Â∞ÜÈÄöËøá JS ÊèíÂÖ•Âà∞ËøôÈáå -->
                
                <!-- Âç°ÈÄöÁâõËßíËâ≤ -->
                <div id="bull-character">
                    <div class="bull-inner">
                        <div class="bull-horns"></div>
                        <div class="bull-body"></div>
                        <div class="bull-head">
                            <div class="bull-eyes">
                                <div class="eye"></div>
                                <div class="eye"></div>
                            </div>
                            <div class="bull-nose"></div>
                            <div class="bull-nose-ring"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Â∫ïÈÉ®ÊéßÂà∂ -->
        <div class="control-panel">
            <div class="flex justify-between text-sm px-2">
                <span class="text-gray-400">BET ON: <span id="selected-room-name" class="text-white font-bold">NONE</span></span>
                <span class="text-gray-400">SURVIVAL YIELD: <span class="text-green-400 font-bold">~14%</span></span>
            </div>

            <div class="bet-options">
                <button class="chip-btn" onclick="selectChip(100)">100</button>
                <button class="chip-btn" onclick="selectChip(500)">500</button>
                <button class="chip-btn" onclick="selectChip(1000)">1K</button>
                <button class="chip-btn" onclick="selectChip('ALL')">ALL</button>
            </div>

            <button id="main-btn" class="action-btn" disabled onclick="placeBet()">
                PLACE BET
            </button>
        </div>

    </div>

    <!-- Ë¥≠‰π∞ÂºπÁ™ó HTML -->
    <div id="buy-modal" class="modal" onclick="if(event.target === this) closeBuyModal()">
        <div class="modal-content">
            <h2 class="text-2xl font-bold text-red-500 mb-2 font-['Bangers'] tracking-wider">GET NTX TOKENS</h2>
            <p class="text-gray-400 text-xs mb-4">Trade on SXC Chain to join the arena.</p>
            
            <div class="text-left text-xs text-gray-500 mb-1">Token Contract (SXC):</div>
            <div class="copy-box" onclick="copyAddress()" title="Click to Copy">
                0x80E265935c31aD60309a6afE6b9e1bfc697B9AD9
            </div>
            <div id="copy-msg" class="text-green-500 text-xs h-4 mb-4"></div>

            <button onclick="window.open('https://dex.sxc.com', '_blank')" class="w-full bg-yellow-600 hover:bg-yellow-500 text-black font-bold py-3 rounded mb-3">
                GO TO DEX
            </button>
            <button onclick="closeBuyModal()" class="text-gray-500 text-sm underline">Close</button>
        </div>
    </div>

    <!-- Custom Wallet Modal -->
    <div id="wallet-modal" class="modal" onclick="if(event.target === this) closeWalletModal()">
        <div class="modal-content flex p-0 overflow-hidden max-w-[600px] w-[95%] h-[400px] bg-[#1a0505] border-2 border-red-600 rounded-xl shadow-[0_0_40px_rgba(255,0,0,0.2)]">
            <!-- Left Sidebar -->
            <div class="w-1/3 bg-[#0f0202] border-r border-red-900/30 p-4 flex flex-col gap-2">
                <div class="text-gray-500 text-xs font-bold mb-2 uppercase tracking-wider">SELECT NETWORK</div>
                <button class="text-left px-4 py-3 rounded bg-red-900/20 text-white font-bold border-l-4 border-red-500 text-sm transition-all">
                    EVM CHAIN
                </button>
                <button onclick="alert('BTC Chain coming soon!')" class="text-left px-4 py-3 rounded hover:bg-white/5 text-gray-600 font-bold border-l-4 border-transparent text-sm transition-all cursor-not-allowed">
                    BTC CHAIN <span class="text-[10px] bg-gray-800 px-1 rounded ml-1">DEV</span>
                </button>
                <button onclick="alert('Solana Chain coming soon!')" class="text-left px-4 py-3 rounded hover:bg-white/5 text-gray-600 font-bold border-l-4 border-transparent text-sm transition-all cursor-not-allowed">
                    SOLANA <span class="text-[10px] bg-gray-800 px-1 rounded ml-1">DEV</span>
                </button>
            </div>
            
            <!-- Right Content -->
            <div class="w-2/3 p-6 bg-[#1a0505] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">CONNECT WALLET</h3>
                    <button onclick="closeWalletModal()" class="text-gray-500 hover:text-white text-2xl">&times;</button>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <!-- MetaMask -->
                    <button onclick="connectProvider('metamask')" class="flex items-center gap-3 p-3 rounded-lg bg-[#2b1010] border border-[#551010] hover:border-red-500 hover:bg-[#3b1515] transition-all group">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" alt="MetaMask" class="w-8 h-8 group-hover:scale-110 transition-transform">
                        <span class="text-sm font-bold text-gray-200 group-hover:text-white">MetaMask</span>
                    </button>

                    <!-- OKX -->
                    <button onclick="connectProvider('okx')" class="flex items-center gap-3 p-3 rounded-lg bg-[#2b1010] border border-[#551010] hover:border-red-500 hover:bg-[#3b1515] transition-all group">
                        <img src="https://static.okx.com/cdn/assets/imgs/247/58E639A4D4829136.png" alt="OKX" class="w-8 h-8 rounded-full group-hover:scale-110 transition-transform">
                        <span class="text-sm font-bold text-gray-200 group-hover:text-white">OKX Wallet</span>
                    </button>

                    <!-- Binance -->
                    <button onclick="connectProvider('binance')" class="flex items-center gap-3 p-3 rounded-lg bg-[#2b1010] border border-[#551010] hover:border-red-500 hover:bg-[#3b1515] transition-all group">
                        <img src="https://public.bnbstatic.com/image/cms/content/body/202309/25/d5225879-69c9-4489-8a82-0223365027a8.png" alt="Binance" class="w-8 h-8 group-hover:scale-110 transition-transform">
                        <span class="text-sm font-bold text-gray-200 group-hover:text-white">Binance</span>
                    </button>

                    <!-- TokenPocket -->
                    <button onclick="connectProvider('tp')" class="flex items-center gap-3 p-3 rounded-lg bg-[#2b1010] border border-[#551010] hover:border-red-500 hover:bg-[#3b1515] transition-all group">
                        <img src="https://tp-statics.tokenpocket.pro/logo/tokenpocket.png" alt="TP" class="w-8 h-8 rounded-full group-hover:scale-110 transition-transform">
                        <span class="text-sm font-bold text-gray-200 group-hover:text-white">TokenPocket</span>
                    </button>

                    <!-- Bitget -->
                    <button onclick="connectProvider('bitget')" class="flex items-center gap-3 p-3 rounded-lg bg-[#2b1010] border border-[#551010] hover:border-red-500 hover:bg-[#3b1515] transition-all group">
                        <img src="https://img.bitgetimg.com/multi_lang_config/0/1663313666666.png" alt="Bitget" class="w-8 h-8 rounded-full group-hover:scale-110 transition-transform">
                        <span class="text-sm font-bold text-gray-200 group-hover:text-white">Bitget</span>
                    </button>

                    <!-- Generic Injected -->
                    <button onclick="connectProvider('injected')" class="flex items-center gap-3 p-3 rounded-lg bg-[#2b1010] border border-[#551010] hover:border-red-500 hover:bg-[#3b1515] transition-all group">
                        <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center group-hover:scale-110 transition-transform">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9" />
                            </svg>
                        </div>
                        <span class="text-sm font-bold text-gray-200 group-hover:text-white">Browser Wallet</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="game-over-modal" class="modal" style="z-index: 2000;">
        <div class="modal-content text-center border-4 border-red-600 bg-black">
            <h2 class="text-4xl font-bold text-red-600 mb-4 font-['Bangers'] tracking-wider animate-pulse">WARNING: ZONE DESTROYED</h2>
            <div id="game-over-msg" class="text-white text-xl mb-6 font-mono"></div>
            <button onclick="location.reload()" class="bg-red-700 hover:bg-red-600 text-white font-bold py-3 px-8 rounded text-lg border-2 border-red-500 shadow-[0_0_20px_rgba(255,0,0,0.5)]">
                REDEPLOY
            </button>
        </div>
    </div>

    <script>
            <script>
        // Debug Logger
        function logToScreen(msg) {
            const consoleEl = document.getElementById('debug-console');
            if(consoleEl) {
                const time = new Date().toLocaleTimeString();
                let finalMsg = msg;
                if (typeof msg === 'object') {
                    try {
                        finalMsg = JSON.stringify(msg, null, 2);
                    } catch(e) {
                        finalMsg = String(msg);
                    }
                }
                consoleEl.innerHTML += `<div style="border-bottom:1px solid #333; padding:2px;">[${time}] ${finalMsg}</div>`;
                consoleEl.scrollTop = consoleEl.scrollHeight;
            }
            console.log(msg);
        }

        // --- Game State Synchronization (Local) ---
        const GameState = {
            load() {
                const now = Date.now();
                let state = null;
                try {
                    state = JSON.parse(localStorage.getItem('ntx_game_state_v1'));
                } catch(e) {}

                // If no state, or state is older than 60s (round over), create new
                if (!state || (now - state.startTime > 60000)) {
                    state = {
                        startTime: now,
                        // Generate fixed random chips for this round
                        roomChips: Array(8).fill(0).map(() => Math.floor(Math.random() * 2000) + 100),
                        // Random target for this round
                        targetId: Math.floor(Math.random() * 8) + 1
                    };
                    localStorage.setItem('ntx_game_state_v1', JSON.stringify(state));
                }
                return state;
            },
            getTimeLeft() {
                const state = this.load();
                const elapsed = (Date.now() - state.startTime) / 1000;
                return Math.max(0, Math.floor(60 - elapsed));
            }
        };

        // Á¥ßÂáëÂ∏ÉÂ±ÄÈÖçÁΩÆ (Â∏¶ÂêçÁß∞)
        const ROOM_CONFIG = [
            { id: 1, name: "BTC MAXI", x: 5, y: 5 },       // Â∑¶‰∏ä
            { id: 2, name: "ETH WHALE", x: 117.5, y: 5 },   // ‰∏≠‰∏ä
            { id: 3, name: "SOL DEGEN", x: 230, y: 5 },     // Âè≥‰∏ä
            { id: 8, name: "MEME KING", x: 5, y: 117.5 },   // Â∑¶‰∏≠
            { id: 4, name: "NFT FLIP", x: 230, y: 117.5 }, // Âè≥‰∏≠
            { id: 7, name: "DEFI APE", x: 5, y: 230 },     // Â∑¶‰∏ã
            { id: 6, name: "DAO GOV", x: 117.5, y: 230 }, // ‰∏≠‰∏ã
            { id: 5, name: "YIELD FARM", x: 230, y: 230 }    // Âè≥‰∏ã
        ];

        let selectedRoomId = null;
        let selectedAmount = 0;
        let timeLeft = 60;
        let isRampaging = true;

        // --- Web3 Integration ---
        const NTX_TOKEN_ADDRESS = '0x80E265935c31aD60309a6afE6b9e1bfc697B9AD9';
        const ARENA_CONTRACT_ADDRESS = '0x5bf67a611690945d396ae641df0e010a79875c8e'; // Updated Arena Address

        let provider, signer, userAddress;
        let ntxContract, arenaContract;

        const ERC20_ABI = [
            "function balanceOf(address owner) view returns (uint256)",
            "function approve(address spender, uint256 amount) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        const ARENA_ABI = [
            "function deposit(uint8 barnId, uint256 amount)",
            "function getCurrentRoundInfo() view returns (uint256, uint256, uint256, uint256[8])"
        ];

        // --- Custom Wallet Logic ---
        
        function openWalletModal() {
            document.getElementById('wallet-modal').classList.add('active');
        }
        
        function closeWalletModal() {
            document.getElementById('wallet-modal').classList.remove('active');
        }

        async function connectProvider(type) {
            console.log("Attempting to connect to:", type);
            let ethProvider = null;

            // 1. Select Provider based on type
            if (type === 'metamask') {
                if (window.ethereum?.isMetaMask) ethProvider = window.ethereum;
                else if (window.ethereum) ethProvider = window.ethereum; // Fallback
            } else if (type === 'okx') {
                if (window.okxwallet) ethProvider = window.okxwallet;
                else if (window.ethereum?.isOkxWallet) ethProvider = window.ethereum;
            } else if (type === 'binance') {
                if (window.BinanceChain) ethProvider = window.BinanceChain;
            } else if (type === 'tp') {
                if (window.ethereum?.isTokenPocket) ethProvider = window.ethereum;
            } else if (type === 'bitget') {
                if (window.bitkeep?.ethereum) ethProvider = window.bitkeep.ethereum;
                else if (window.bitget?.ethereum) ethProvider = window.bitget.ethereum;
            } else if (type === 'injected') {
                 ethProvider = window.ethereum;
            }

            // Fallback: If specific provider not found, try generic window.ethereum
            if (!ethProvider) {
                console.warn(`Specific provider for ${type} not found.`);
                if (window.ethereum) {
                    console.log("Falling back to generic window.ethereum");
                    ethProvider = window.ethereum;
                } else {
                    alert(`Wallet extension not found. Please install it first!`);
                    return;
                }
            }

            try {
                const btnText = document.getElementById('wallet-btn-addr');
                btnText.innerText = "CONNECTING...";
                
                // Request Accounts
                const accounts = await ethProvider.request({ method: 'eth_requestAccounts' });
                
                if (!accounts || accounts.length === 0) throw new Error("No accounts found");
                
                userAddress = accounts[0];
                
                // Setup Ethers Provider
                provider = new ethers.providers.Web3Provider(ethProvider);
                signer = provider.getSigner();

                // Setup Contracts
                ntxContract = new ethers.Contract(NTX_TOKEN_ADDRESS, ERC20_ABI, signer);
                arenaContract = new ethers.Contract(ARENA_CONTRACT_ADDRESS, ARENA_ABI, signer);

                // Update UI
                updateUI();
                updateBalance();
                closeWalletModal();

                // Listen for changes
                if(ethProvider.on) {
                    ethProvider.on('accountsChanged', (accs) => {
                        if(accs.length > 0) {
                            userAddress = accs[0];
                            updateUI();
                            updateBalance();
                        } else {
                            window.location.reload();
                        }
                    });
                    ethProvider.on('chainChanged', () => window.location.reload());
                }

            } catch (error) {
                console.error("Connection Error:", error);
                alert("Connection Failed: " + (error.message || "User Rejected"));
                document.getElementById('wallet-btn-addr').innerText = "CONNECT";
            }
        }

        function connectWallet() {
            openWalletModal();
        }

        function updateUI() {
            const btn = document.getElementById('connect-btn');
            const btnText = document.getElementById('wallet-btn-addr');
            const shortAddr = userAddress.slice(0, 4) + '...' + userAddress.slice(-4);
            btnText.innerText = shortAddr;
            document.getElementById('wallet-indicator').classList.remove('bg-red-500');
            document.getElementById('wallet-indicator').classList.add('bg-green-500');
            btn.disabled = false;
        }

        async function updateBalance() {
            if (!ntxContract) return;
            try {
                const balance = await ntxContract.balanceOf(userAddress);
                const formatted = ethers.utils.formatEther(balance);
                document.getElementById('user-balance').innerText = Math.floor(parseFloat(formatted)).toLocaleString();
            } catch (e) {
                console.log("Error fetching balance (probably wrong network)", e);
                document.getElementById('user-balance').innerText = "ERR";
            }
        }

        async function placeBet() {
            if (!arenaContract) {
                alert("Please connect wallet first!");
                connectWallet();
                return;
            }
            
            if (ARENA_CONTRACT_ADDRESS === '0xfe21c10a57a1d6c4e16844b250a0764a84a4fa77') {
                alert("Arena Contract Address not set! Please deploy the contract first.");
                return;
            }

            const amount = selectedAmount === 'ALL' ? 
                await ntxContract.balanceOf(userAddress) : 
                ethers.utils.parseEther(selectedAmount.toString());

            try {
                const btn = document.getElementById('main-btn');
                const originalText = btn.innerText;
                btn.disabled = true;
                btn.innerText = "APPROVING...";

                // 1. Check Allowance
                const allowance = await ntxContract.allowance(userAddress, ARENA_CONTRACT_ADDRESS);
                if (allowance.lt(amount)) {
                    const tx = await ntxContract.approve(ARENA_CONTRACT_ADDRESS, ethers.constants.MaxUint256);
                    await tx.wait();
                }

                // 2. Deposit
                btn.innerText = "SENDING TX...";
                const tx = await arenaContract.deposit(selectedRoomId, amount);
                await tx.wait();

                alert("Bet Placed Successfully!");
                updateBalance();
                btn.innerText = originalText;
                btn.disabled = false;

            } catch (error) {
                console.error(error);
                alert("Transaction Failed: " + (error.data?.message || error.message));
                document.getElementById('main-btn').disabled = false;
                document.getElementById('main-btn').innerText = "TRY AGAIN";
            }
        }

        // ÁîüÊàêÊú®Ë¥®ÁâõÊ†è SVG
        function createPenSVG() {
            return `
            <svg viewBox="0 0 105 105" class="room-bg-svg" preserveAspectRatio="none">
                <!-- Âú∞ÊùøÈò¥ÂΩ± -->
                <path d="M5 85 L100 85 L90 95 L15 95 Z" fill="rgba(0,0,0,0.5)" />
                
                <!-- ÂêéÂ¢ô (Ê∑±Ëâ≤Êú®Á∫π) -->
                <rect x="10" y="25" width="85" height="60" fill="#2D1B1B" stroke="#3E2723" stroke-width="1"/>
                <line x1="10" y1="40" x2="95" y2="40" stroke="#3E2723" stroke-width="1" opacity="0.5"/>
                <line x1="10" y1="55" x2="95" y2="55" stroke="#3E2723" stroke-width="1" opacity="0.5"/>
                <line x1="10" y1="70" x2="95" y2="70" stroke="#3E2723" stroke-width="1" opacity="0.5"/>

                <!-- È°∂Ê£ö (ÈÄèËßÜ) -->
                <path d="M5 25 L52.5 5 L100 25" fill="#3E2723" stroke="#5D4037" stroke-width="2"/>
                <path d="M15 25 L52.5 12 L90 25" fill="none" stroke="#4E342E" stroke-width="1"/>

                <!-- ‰æßÂ¢ô (ÈÄèËßÜ) -->
                <path d="M5 25 L10 25 L10 85 L5 85 Z" fill="#3E2723" />
                <path d="M100 25 L95 25 L95 85 L100 85 Z" fill="#3E2723" />

                <!-- ÂâçÂõ¥Ê†è (ÈÄèËßÜÊú®Ê†è) -->
                <!-- Êü±Â≠ê -->
                <rect x="5" y="25" width="5" height="65" fill="#4E342E" />
                <rect x="95" y="25" width="5" height="65" fill="#4E342E" />
                <rect x="30" y="60" width="4" height="30" fill="#4E342E" />
                <rect x="70" y="60" width="4" height="30" fill="#4E342E" />
                
                <!-- Ê®™Ê†è -->
                <path d="M5 80 L100 80" stroke="#5D4037" stroke-width="3" />
                <path d="M5 65 L100 65" stroke="#5D4037" stroke-width="3" />
                
                <!-- Èó®Èó©ÁªÜËäÇ -->
                <rect x="45" y="62" width="15" height="20" fill="none" stroke="#8D6E63" stroke-width="1" />
            </svg>
            `;
        }

        function init() {
            const grid = document.getElementById('arena-grid');
            const gameState = GameState.load(); // Load synchronized state
            
            ROOM_CONFIG.forEach((pos, index) => {
                const room = document.createElement('div');
                room.className = 'room-card';
                room.style.left = pos.x + 'px';
                room.style.top = pos.y + 'px';
                room.dataset.id = pos.id;
                room.onclick = () => selectRoom(pos.id, pos.name, room);

                // ÊèíÂÖ• SVG ËÉåÊôØ
                room.innerHTML = createPenSVG();

                // ÊàøÈó¥ÂêçÁß∞Ê†áÁ≠æ
                const label = document.createElement('div');
                label.className = 'room-label';
                label.innerText = pos.name;
                room.appendChild(label);
                
                // Èü≠ËèúÁæ§
                const people = document.createElement('div');
                people.className = 'people-group';
                // ÈöèÊú∫ÁîüÊàê‰∏Ä‰∫õÈü≠Ëèú
                for(let i=0; i<Math.random()*15+5; i++) {
                    const p = document.createElement('div');
                    p.className = 'leek';
                    p.style.animationDelay = (Math.random() * 2) + 's';
                    // ÈöèÊú∫È´òÂ∫¶
                    p.style.height = (Math.random() * 8 + 8) + 'px';
                    people.appendChild(p);
                }
                room.appendChild(people);

                // Â∫ïÈÉ®ÈáëÈ¢ù (‰ΩøÁî®ÂêåÊ≠•ÁöÑÁä∂ÊÄÅ)
                const footer = document.createElement('div');
                footer.className = 'text-[10px] font-bold text-yellow-500 z-20 mt-1 bg-black/50 px-1 rounded';
                // Use the chip count from the synchronized state based on index
                footer.innerText = gameState.roomChips[index]; 
                room.appendChild(footer);

                grid.appendChild(room);
            });

            startTimer();
            startBullRampage();
        }
        
        // ... existing code ...

        function startTimer() {
            const timerEl = document.getElementById('bg-timer');
            
            // Clear any existing interval to prevent duplicates
            if (window.gameTimerInterval) clearInterval(window.gameTimerInterval);

            window.gameTimerInterval = setInterval(() => {
                // Get time from shared state
                timeLeft = GameState.getTimeLeft();
                
                timerEl.innerText = timeLeft;
                if (timeLeft <= 10) timerEl.style.color = 'rgba(255, 0, 0, 0.3)';
                
                if (timeLeft <= 0) {
                    clearInterval(window.gameTimerInterval);
                    isRampaging = false;
                    // Only trigger final attack if not already triggered
                    if (!document.querySelector('.impacted')) {
                        finalAttack();
                    }
                }
            }, 1000);
        }

        // ÁñØÁâõÊåÅÁª≠ÂÜ≤ÊíûÈÄªËæë (‰øùÁïô‰Ω†ÂñúÊ¨¢ÁöÑÂÖ®Âú∫Â•îË¢≠)
        function startBullRampage() {
            if (!isRampaging) return;

            const bull = document.getElementById('bull-character');
            const bullInner = bull.querySelector('.bull-inner');
            
            // 1. ÈöèÊú∫ÈÄâÊã©‰∏Ä‰∏™ÁõÆÊ†áÊàøÈó¥
            const targetIndex = Math.floor(Math.random() * ROOM_CONFIG.length);
            const target = ROOM_CONFIG[targetIndex];
            
            // 2. ËÆ°ÁÆóÂÜ≤ÊíûÁÇπ
            const roomCX = target.x + 52.5;
            const roomCY = target.y + 52.5;
            const arenaCX = 170;
            const arenaCY = 170;
            
            const dx = roomCX - arenaCX;
            const dy = roomCY - arenaCY;
            
            const distance = Math.sqrt(dx*dx + dy*dy);
            const moveRatio = 60 / distance; 
            
            const moveX = arenaCX + dx * moveRatio;
            const moveY = arenaCY + dy * moveRatio;

            // 3. ÁßªÂä®Áâõ
            bull.style.left = moveX + 'px';
            bull.style.top = moveY + 'px';
            
            // ËΩ¨Âêë
            if (dx > 0) {
                bullInner.style.transform = 'scaleX(-1)'; 
            } else {
                bullInner.style.transform = 'scaleX(1)'; 
            }

            // 4. ÊíûÂáªÂä®‰Ωú
            setTimeout(() => {
                const hitX = arenaCX + dx * (moveRatio + 0.2);
                const hitY = arenaCY + dy * (moveRatio + 0.2);
                
                bull.style.left = hitX + 'px';
                bull.style.top = hitY + 'px';
                
                // ÊàøÈó¥ÈúáÂä®
                const roomEl = document.querySelector(`.room-card[data-id="${target.id}"]`);
                roomEl.classList.add('impacted');
                createDust(hitX, hitY);

                setTimeout(() => {
                    roomEl.classList.remove('impacted');
                    
                    // 5. ÂõûÂà∞‰∏≠ÂøÉ
                    setTimeout(() => {
                        bull.style.left = '170px';
                        bull.style.top = '170px';
                        setTimeout(startBullRampage, 300); // Âø´ÈÄüÂæ™ÁéØ
                    }, 150);
                }, 150);
            }, 250);
        }

        function createDust(x, y) {
            const grid = document.getElementById('arena-grid');
            const dust = document.createElement('div');
            dust.className = 'dust';
            dust.style.left = x + 'px';
            dust.style.top = y + 'px';
            grid.appendChild(dust);
            setTimeout(() => dust.remove(), 500);
        }

        function finalAttack() {
            const bull = document.getElementById('bull-character');
            
            // Use synchronized target ID
            const gameState = GameState.load();
            // Ensure targetId is valid (1-8)
            const targetId = gameState.targetId || (Math.floor(Math.random() * 8) + 1);
            
            const targetRoom = document.querySelector(`.room-card[data-id="${targetId}"]`);
            
            if (!targetRoom) return; // Safety check

            bull.style.transform = 'translate(-50%, -50%) scale(1.5)';
            bull.style.transition = 'all 0.2s';
            
            const rect = targetRoom.style;
            const tx = parseInt(rect.left) + 50;
            const ty = parseInt(rect.top) + 50;
            
            bull.style.left = tx + 'px';
            bull.style.top = ty + 'px';
            
            setTimeout(() => {
                targetRoom.classList.add('impacted');
                targetRoom.style.filter = 'grayscale(100%) brightness(0.5)';
                document.body.style.backgroundColor = '#FF3D00';
                setTimeout(() => document.body.style.backgroundColor = '#050505', 100);
                
                setTimeout(() => {
                    // Use custom modal instead of alert
                    const modal = document.getElementById('game-over-modal');
                    const msg = document.getElementById('game-over-msg');
                    msg.innerText = `GAME OVER! Room #${targetId} Destroyed.`;
                    modal.classList.add('active');
                }, 500);
            }, 300);
        }

        init();

    </script>
</body>
</html>
